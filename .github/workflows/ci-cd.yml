name: CI/CD Pipeline

on:
  push:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build Docker Image
        run: docker build -t vivek512/flask:latest .

      - name: Push Docker Image
        run: docker push vivek512/flask:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Set up KubeConfig
        run: |
          echo "YXBpVmVyc2lvbjogdjEKY2x1c3RlcnM6Ci0gY2x1c3RlcjoKICAgIGNlcnRpZmljYXRlLWF1dGhvcml0eS1kYXRhOiBMUzB0TFMxQ1JVZEpUaUJEUlZKVVNVWkpRMEZVUlMwdExTMHRDazFKU1VSQ1ZFTkRRV1V5WjBGM1NVSkJaMGxKUWtNck9VZG9UemxVUkVGM1JGRlpTa3R2V2tsb2RtTk9RVkZGVEVKUlFYZEdWRVZVVFVKRlIwRXhWVVVLUVhoTlMyRXpWbWxhV0VwMVdsaFNiR042UVdWR2R6QjVUbFJCTUUxcVVYZE9WRWt3VFZSc1lVWjNNSHBPVkVFd1RXcEpkMDVVU1RCTlZHeGhUVUpWZUFwRmVrRlNRbWRPVmtKQlRWUkRiWFF4V1cxV2VXSnRWakJhV0UxM1oyZEZhVTFCTUVkRFUzRkhVMGxpTTBSUlJVSkJVVlZCUVRSSlFrUjNRWGRuWjBWTENrRnZTVUpCVVVNd2VWQnBSRVJwVjNwM2VrczBNRUpWUWtrMVYwZGxkMEpqVnpkNlRtNHpjV1I2YmtOUmNVeEZSVUZZYWpOU09YRkNNMUExTmtWdVRWVUthMEZLTmxkb1psSkpUV1ZMZVdoTk1tRjFLMlZyY2pVM1lYWmxUbkpTVG1Oc09XWTVWbHAyU2pGTFlrbE9ORFpGVmtKSFVYSjFMekp5VFhoNVVuVlhlZ3BQUlU5UlZtWlJkRXh0T0RoeFFXeG9kSEZLUmxSbVVDODFZa3BPYzJKMFlrc3hjMjloVG1SMWEweHVlSEpKV2pKb1RFTmhVakZZU1ZwT2RUZEVUMko2Q21odGEwZE5WRUZ0TlRGMFlYVjVaMVp6SzJrd1lreE9SR3BoVDJodmJpdExZbUpOU1dKT1l5OW1jMmhaV0haRUwwRXhRemR6Tnpaa2RHcG1WRkUyUkRFS1MxRnhZa05zTjFaalUzWktNVk5PUWxWYVUwUkdlVlZCZGxWYWQzbDVaMmx1WlhScllreEtXVEUyTWtkNVdtZENkWEZHUnpVMlNHRlFkV2RpU0RSVFZRcDBZMlJNU2sxTlUyZEdTMGh4U1U5bVVIQkJUMDFuUTB4V1VGYzVRV2ROUWtGQlIycFhWRUpZVFVFMFIwRXhWV1JFZDBWQ0wzZFJSVUYzU1VOd1JFRlFDa0puVGxaSVVrMUNRV1k0UlVKVVFVUkJVVWd2VFVJd1IwRXhWV1JFWjFGWFFrSlNWMlJPSzA1cFQxazBjaXRhV2xReVRUSkhPR2x3VDNCTGFVdHFRVllLUW1kT1ZraFNSVVZFYWtGTloyZHdjbVJYU214amJUVnNaRWRXZWsxQk1FZERVM0ZIVTBsaU0wUlJSVUpEZDFWQlFUUkpRa0ZSUVhsSEsyNTFjbGg1TkFvMFNFeDNPR1ZQY1U4M1YwTlZNbWRSZG5salYwcG5NbWt2WVdkc1lqaGFhSGhsVFROQlZ5dFVhV3R0TURKdGVHazBZbkkzTlVwNFFYYzBhbWxaZERoVkNsTk1NMVZ4UW5VM1QyVk9WVkEzUlRVeVozQTVUWFpuU2t0WFpqbEJVVzltVFRneE1uZHFWVFJ1VEZoTFMzTkNjRmxCZW5ZcldEbFdlbWhNUm1oa2MwRUtWVTQxWWxJdmRqQTJjVVJLVVdoME1teE1VbkZIUW5KWVYyUlJjRmg1UzJadlpYQkhSMGRWZVhoNGIyOHJkMGd4UW5oa1JHZHFabVV6UVVWSlFtTTNNQXBzYVVaNk0yeHpSVzlwTlRsQlVWVnZRV3huUkdWdU56aFNhVkJyU1VWcGF6QnNjMVZUWkRCV1FqaHVOSFo1YUU5VFEwUTJkV3hQWW1zMGNtcGxaVUZMQ25WQ2JHRlFaVEExYlROQ2IySXlXRWRWWTFaQmQxRlBia1l4WldkMlVFUnROR1JXZVdsUU16bFRaSGxSUXpsWlpIWndiRWh5VjBrdlRHbEJkbGhXVEVRS1ltdGlVSGRyZGtJM1dtcEtDaTB0TFMwdFJVNUVJRU5GVWxSSlJrbERRVlJGTFMwdExTMEsKICAgIHNlcnZlcjogaHR0cHM6Ly9rdWJlcm5ldGVzLmRvY2tlci5pbnRlcm5hbDo2NDQzCiAgbmFtZTogZG9ja2VyLWRlc2t0b3AKLSBjbHVzdGVyOgogICAgY2VydGlmaWNhdGUtYXV0aG9yaXR5OiAvaG9tZS92aXZlay8ubWluaWt1YmUvY2EuY3J0CiAgICBleHRlbnNpb25zOgogICAgLSBleHRlbnNpb246CiAgICAgICAgbGFzdC11cGRhdGU6IEZyaSwgMjUgQXByIDIwMjUgMTM6MzA6NTYgSVNUCiAgICAgICAgcHJvdmlkZXI6IG1pbmlrdWJlLnNpZ3MuazhzLmlvCiAgICAgICAgdmVyc2lvbjogdjEuMzUuMAogICAgICBuYW1lOiBjbHVzdGVyX2luZm8KICAgIHNlcnZlcjogaHR0cHM6Ly8xOTIuMTY4LjM5LjE5Ojg0NDMKICBuYW1lOiBtaW5pa3ViZQpjb250ZXh0czoKLSBjb250ZXh0OgogICAgY2x1c3RlcjogZG9ja2VyLWRlc2t0b3AKICAgIHVzZXI6IGRvY2tlci1kZXNrdG9wCiAgbmFtZTogZG9ja2VyLWRlc2t0b3AKLSBjb250ZXh0OgogICAgY2x1c3RlcjogbWluaWt1YmUKICAgIGV4dGVuc2lvbnM6CiAgICAtIGV4dGVuc2lvbjoKICAgICAgICBsYXN0LXVwZGF0ZTogRnJpLCAyNSBBcHIgMjAyNSAxMzozMDo1NiBJU1QKICAgICAgICBwcm92aWRlcjogbWluaWt1YmUuc2lncy5rOHMuaW8KICAgICAgICB2ZXJzaW9uOiB2MS4zNS4wCiAgICAgIG5hbWU6IGNvbnRleHRfaW5mbwogICAgbmFtZXNwYWNlOiBkZWZhdWx0CiAgICB1c2VyOiBtaW5pa3ViZQogIG5hbWU6IG1pbmlrdWJlCmN1cnJlbnQtY29udGV4dDogbWluaWt1YmUKa2luZDogQ29uZmlnCnByZWZlcmVuY2VzOiB7fQp1c2VyczoKLSBuYW1lOiBkb2NrZXItZGVza3RvcAogIHVzZXI6CiAgICBjbGllbnQtY2VydGlmaWNhdGUtZGF0YTogTFMwdExTMUNSVWRKVGlCRFJWSlVTVVpKUTBGVVJTMHRMUzB0Q2sxSlNVUlJha05EUVdseFowRjNTVUpCWjBsSlUwRlRRazlWWTB0dVEyOTNSRkZaU2t0dldrbG9kbU5PUVZGRlRFSlJRWGRHVkVWVVRVSkZSMEV4VlVVS1FYaE5TMkV6Vm1sYVdFcDFXbGhTYkdONlFXVkdkekI1VGxSQk1FMXFVWGRPVkVrd1RWUnNZVVozTUhsT2FrRXdUV3BSZDA1VVNUQk5WR3hoVFVSWmVBcEdla0ZXUW1kT1ZrSkJiMVJFYms0MVl6TlNiR0pVY0hSWldFNHdXbGhLZWsxU2MzZEhVVmxFVmxGUlJFVjRTbXRpTWs1eVdsaEpkRnB0T1hsTVYxSnNDbU15ZERCaU0wRjNaMmRGYVUxQk1FZERVM0ZIVTBsaU0wUlJSVUpCVVZWQlFUUkpRa1IzUVhkblowVkxRVzlKUWtGUlJFRTVjRWx4YTBwQ1dqZFJjbW9LVG1wdWFEbElRM2xVZFZCV2VWUk5lRTVCY0hOTWJEaFVhRlJaYm1WSVpqZ3JjVll6Y1dobFdXVmlhbXM0U1hWNGNrbG9SRFl5ZUV4V1JuSkNRa2xLVmdwUVJXVTNlaXRUVkV4MWMzZE5SVzV4YlZORkswbzRaelF2V1RabWJVeENORVJWU1hGTGNXWlZWMXBZYzA1T2IxUnlSMlV4UjBab1RVazRZamhDVG5aUUNpdHhVVU5YYWtoelRFVlVibGhDUzFoNmMwRklWRmczU2taR1REQm9ibmQ2ZG1KVVRtcFlibXBvWlhCQlYwbG5lREpPYlZabVJsSXpaRFJTWnpWTU5rY0tiakZwZVhVMk5ucFZOVEp5TTJOQmRHaHVSR2gzTUVveWFVd3JRbFZTUldKek9XSTFhbXhNU1VWVE1EbHRWMkp4YkhsYVRHdGFLM2s1WVM5V1pFeENOZ3B0T0hkSmVrTTNibkpKVW5CR1FVWnRZa2xKY1dGSVMyUXlaV3h0SzFFNE9YRlFTbVE0TUVSdVlYUTJhRk5UYjNWYWNFdE9iM05rUmtKRmNtVTNZbXhOQ2psQ1dsQkVRa1pNUVdkTlFrRkJSMnBrVkVKNlRVRTBSMEV4VldSRWQwVkNMM2RSUlVGM1NVWnZSRUZVUW1kT1ZraFRWVVZFUkVGTFFtZG5ja0puUlVZS1FsRmpSRUZxUVUxQ1owNVdTRkpOUWtGbU9FVkJha0ZCVFVJNFIwRXhWV1JKZDFGWlRVSmhRVVpHV2pBek5ESkpOV3BwZGpWc2JGQlplbGxpZVV0ck5ncHJjVWx4VFVJd1IwRXhWV1JGVVZGWFRVSlRRMFZ0VW5aWk1uUnNZMmt4YldJelNYUmFSMVo2WVROU2RtTkVRVTVDWjJ0eGFHdHBSemwzTUVKQlVYTkdDa0ZCVDBOQlVVVkJWR0ZpTjNOdFkxcElPR3RTTlV3NU1XaHdSVlZ6WmxBNGVTdFdZa1J2UVVOUE1GTmlhR1pQZURZMWJIbDVWRTgzYzNZclQxTndka0VLUWtodGEyWlNaV0Z1ZW5SbFVsRXdiMGgwYTFZMlVXTk9iek5WTUZoNWVFaHBRM0JFUVZNck9YWklWMDh6UkdkWGNERktTRUZZV0RORlZsWnRhM1JMYlFwSmVEWk1URU4zZG5sVlRXRkRibTkwY0hsQ1lsbFNjMnA2TjBob1RFTmtPR0ZJWWxoTWIyZ3JRalYwVWpkbFlWbEpPVkJCUjFkeU9FOWxkRWhZY0hwYUNuWm5TRUpsTkdwYU5EWnFkV0pxWTB0T1YwMUtXVGR4VFRSbVQxaGFiRElyVTA1c05FdE9RakZTYnl0QlprZ3JURTVWY0ZGMlpIUllZemhHV1ZaeWJDOEtSbTF0T1dKVVVrVndiMVZVY1c5SVpXbDBVbUZYYzNkV09XWTFSSGwwUkdwSllpOWhRVzFJTXpWTGExTlJNVzVyYTJGU1JYbDZlbmN2VGs0dlFtSkJTQXB1V1d0M1FtbEdUMWc0YzFOdVpHcHFORFYwYUdacFNqQk1TV2xUTDNjOVBRb3RMUzB0TFVWT1JDQkRSVkpVU1VaSlEwRlVSUzB0TFMwdENnPT0KICAgIGNsaWVudC1rZXktZGF0YTogTFMwdExTMUNSVWRKVGlCU1UwRWdVRkpKVmtGVVJTQkxSVmt0TFMwdExRcE5TVWxGYjNkSlFrRkJTME5CVVVWQmQxQmhVMHR3UTFGWFpUQkxOSHBaTlRSbVVuZHphemRxTVdOcmVrMVVVVXRpUXpWbVJUUlZNa296YURNdlVIRnNDbVEyYjFodFNHMDBOVkJEVEhOaGVVbFJLM1J6VXpGU1lYZFJVME5XVkhoSWRUZ3ZhMnQ1TjNKTlJFSktObkJyYUZCcFprbFBVREpQYmpWcGQyVkJNVU1LUzJseGJqRkdiVlkzUkZSaFJUWjRiblJTYUZsVVExQkhMMEZVWW5vdmNXdEJiRzk0TjBONFJUVXhkMU5zT0RkQlFqQXhLM2xTVWxNNVNWbzRUVGN5TUFwNldURTFORFJZY1ZGR2FVbE5aR3BhYkZoNFZXUXpaVVZaVDFNcmFIQTVXWE55ZFhWek1VOWtjVGt6UVV4WlduYzBZMDVEWkc5cEwyZFdSVkpITjFCWENpdFpOVk41UWtWMFVGcHNiVFp3WTIxVE5VZG1jM1pYZGpGWVUzZGxjSFpOUTAxM2RUVTJlVVZoVWxGQ1dtMTVRMHR0YUhsdVpHNXdXblpyVUZCaGFua0tXR1pPUVRVeWNtVnZWV3R4VEcxaFUycGhURWhTVVZKTE0zVXlOVlJRVVZkVWQzZFNVM2RKUkVGUlFVSkJiMGxDUVVaMlpsTmtjSGRPTDNCSmVsRXdMd3BFVkVsVGMzWkhRMlJEUjJWcFVIZGtVR1pWYURSMWVXeFhVa3BVTTJwVldteFdlWHBLUldKYVpGaHRlazlhSzJabFRWWXhkVzV5Ymt3NGNVVm1hRlpqQ2k5UU5XcDZaakY0YzJ4TFowOTVSWGxTVlhsV2JteFFZMFJYVEZwVVVGQnllRUoyVm1OV1F5dFZielZETXpZelRWRlNhRTB2WjFaTFdqTjNiMU5CZG5VS01YUlhlalJrT0VSbFRUYzJNMGhPWnpSaVlsbFpPSGRVU0VOblJscHpjWE5wUW5kRU9VUTJkVGswU0dscGJtVk9VWFZXWTNaME1XZFhlRE0xTWs0dmR3cFdlRzVNYVRabk9ISTBWMUp1ZDNveVRtODJPSFZ2U2xWeWJWSkdaRU5zWlZOM1ZWQjBaSE5zYURsdVFXZHFUMVo0ZFVSbmIwcE1XREoyTTI1dVozRlBDamQxTVc5clMwSnVSamh6VVU1M0t6YzNiMkYzWnpGMmEyMDBUWGRvWmtGV2VYSXJjRXBGYmpJeFJsZGxUVVZQY0hKdU1IUXpXa05PYUU5alUzVnpUVllLYVdzM1VWTlFSVU5uV1VWQksyeGlaRzlLVm1wS2JqVlJlREprWldRcmR6SkxUa1JDVURNdmN6TXhPVzFHV2pKQ05tOTBkbmRuYVdreFpGY3dhalE0UkFwUGRtdHFZalpPTUZNNGJGSXliMnRYVWtka1JGWllMMVZVVFVJNU9Vc3ZORFp4UzFKalVrWjVRVTFKYTNCU1ZIQkNTUzlaUzNBMVpFY3hZbm81TkVKUUNrRk5iVU5oZFdoNVJGZ3dRa0ZPUm1WVGFVOWFUblZoUlZaVk5GYzVXVUpJVjNSc2NHZHpkM2hVZGtwM2F6aE1Za2hzVmxsamVFMURaMWxGUVhoV1QxTUtjMjl5VVhWV2NVbE1LMVJKVkhvNWRGVXlaamN3WjNOTmRVZFlkWFphU1d4eWRuVnlUblJRWW1FMmFXbFJOMU15UjFGMlZuZGpRVEZXYkdvM01XMHJUQW8wTlZsbFZGRXZNa05GT1hOTFV6bGhhbFJxY1hobWFqRXZkekpzYWxCT1YyMVlWM2hMVFdWUWJGVndORGxOTlZOdWFqWlhZM0JrYmtZM2RrUkNPV2x4Q2s5NGEzRm5kMGx3ZGtablZ5OXFTa1pEWkVZMlR6QldMMUV5Vlc1TlR6STBZVXBtY3prcmEwTm5XVVZCTlV0NFpYSkxXbkJQUzNSbU4wcFpka0pCY1djS1pXMDBaV0ZJZGxwcGVqSm5hVnBSYTB4WVUweGtUVzVuZGsxWlIzUnlRV3BsYTFwRlMxZEZPVUpXUm5veFRsVjFiM1pPVlROWkx6QkNUbmM0T0dwMVp3cGxLM2hsVVU1T00zVk9kV1pFTjBSdVNHTlRjalpHY0dGdlNFOTNWRmRDUjFOdGFrbEhhRWxWZUU0NWQwRkRhRUZKYVdOalpVeHlaa2hRUmtaS1lVc3hDa016WWxneU5sQmpWWE53UWt4aGFISTRaWGg0TjBWTlEyZFpRa05pWjNONE0ycGxPRmh5VlVGWmNWaHZkaTlMWmtwS0sweExOM05vYWxCa1pHcEphbmdLUzNKeFQwZzJOVGQ0VHpaNmJXMHJMMkZPVDFObldrZDZUM2QxTVU5cFNTOUJVR1U0WlRoWldrMUNkVFpzWWpKSVZUUlVLMFoyTVVJeWVXUkViREYzZEFwR05HdEljMGc0ZGtKRU5VdE5MMlIxV0V0WGNtVkVjakZ4TTJ4U09TdG1MMDB3Tm5wbmFGQnZNakJOUzFkdlVWSmtVbk5SVUhsd1JERjRZbXhwZGtsT0NrUkVRbnB0VVV0Q1owTmlNWGRsY1dkQ1ZFNHZjMXBEVDNNd1lXOXZhR29yWVVoSlppOTBjbWgzZEdac1YwZEpkamRzTkRGbVozQjNjRGszU21wTWNYWUtka00wWmtOVldtbFNXalJ2YTBoT2NIbDRSbGRpVkdwclRXSTFaR2xNV2tVdmJuUXZWalZrTlM4M1IwSkpOMnQ0WTJ4MGVrSmxUMkZ6ZDA5SGRDOXlTQXBNUjBKaGFGSldWbkpEYW5Jek5XcEhiVkZXSzNsbGFGUlVaVmRISzFsTWNISmhiVGw1WWxsMVEySnVVMEV6VDB4WE1ISTVDaTB0TFMwdFJVNUVJRkpUUVNCUVVrbFdRVlJGSUV0RldTMHRMUzB0Q2c9PQotIG5hbWU6IG1pbmlrdWJlCiAgdXNlcjoKICAgIGNsaWVudC1jZXJ0aWZpY2F0ZTogL2hvbWUvdml2ZWsvLm1pbmlrdWJlL3Byb2ZpbGVzL21pbmlrdWJlL2NsaWVudC5jcnQKICAgIGNsaWVudC1rZXk6IC9ob21lL3ZpdmVrLy5taW5pa3ViZS9wcm9maWxlcy9taW5pa3ViZS9jbGllbnQua2V5Cg" | base64 -d > kubeconfig
          mv kubeconfig $HOME/.kube/config
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.27.0'

      - name: Update Kubernetes Deployment
        run: |
          kubectl set image deployment/flask-app flask-container=vivek512/flask:latest
          kubectl rollout status deployment/flask-app
